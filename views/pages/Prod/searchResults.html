<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Résultats de recherche – SoraDrive</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Sora:wght@400;700&display=swap"
    rel="stylesheet"
  >
  <link rel="stylesheet" href="searchResults.css">
</head>
<body>

  <!-- Navbar -->
  <header class="top-bar">
    <!-- logo rond en background, plus aucun texte à l'intérieur -->
    <div class="logo" aria-label="SoraDrive"></div>

    <form class="search-box" id="searchForm" action="searchResults.html" method="GET">
      <input type="text" name="query" id="searchInput" placeholder="Search">
      <button type="submit">🔍</button>
    </form>

    <nav class="main-nav">
      <a href="home.html">Accueil</a>
      <a href="gestionTrajets.html">Trajets</a>
      <a href="profil.html">Profil</a>
      <a href="Contact.html">Contact</a>
    </nav>
  </header>

  <!-- Conteneur principal -->
  <div class="search-container">
    <!-- Filtres -->
    <aside class="filters">
      <h3>Filtres</h3>

      <h4>Départ</h4>
      <select class="filter-select">
        <option value="">– Choisir une ville –</option>
        <option>Paris</option>
        <option>Lyon</option>
        <option>Marseille</option>
        <option>Toulouse</option>
        <option>Nice</option>
        <option>Nantes</option>
        <option>Strasbourg</option>
        <option>Bordeaux</option>
        <option>Lille</option>
        <option>Rennes</option>
      </select>

      <h4>Arrêts</h4>
      <select class="filter-multiselect" multiple size="6">
        <option>Paris</option>
        <option>Rouen</option>
        <option>Le Havre</option>
        <option>Orléans</option>
        <option>Tours</option>
        <option>Dijon</option>
        <!-- … autres villes … -->
      </select>

      <h4>Arrivée</h4>
      <details class="filter-dropdown">
        <summary>– Choisir une ville –</summary>
        <ul>
          <li>Paris</li>
          <li>Lyon</li>
          <li>Marseille</li>
          <li>Toulouse</li>
          <li>Nice</li>
          <li>Nantes</li>
          <li>Strasbourg</li>
          <li>Bordeaux</li>
          <li>Lille</li>
          <li>Rennes</li>
        </ul>
      </details>
    </aside>

    <!-- Résultats -->
    <section class="results">
      <h2>Aucune recherche effectuée.</h2>
      <ul>
        <li data-url="reserverTrajets.html">Résultat Trajet 1</li>
        <li data-url="reserverTrajets.html">Résultat Trajet 2</li>
        <li data-url="reserverTrajets.html">Résultat Trajet 3</li>
      </ul>
    </section>

    <!-- Pub -->
    <aside class="ad">
      <h3>PUB ?</h3>
    </aside>
  </div>

  <!-- Modal overlay -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <button id="closeBtn" class="modal-close">&times;</button>
      <iframe id="modalFrame" src=""></iframe>
    </div>
  </div>

  <!-- Script : ouverture/fermeture modal + AJAX search -->
  <script>
    // Gestion de la modal
    document.querySelectorAll('.results li').forEach(item => {
      item.addEventListener('click', () => {
        document.getElementById('modalFrame').src = item.dataset.url;
        document.getElementById('modal').classList.add('open');
      });
    });
    document.getElementById('closeBtn').addEventListener('click', () => {
      document.getElementById('modal').classList.remove('open');
      document.getElementById('modalFrame').src = '';
    });
    document.getElementById('modal').addEventListener('click', e => {
      if (e.target.id === 'modal') {
        document.getElementById('closeBtn').click();
      }
    });

    // Recherche AJAX
    document.addEventListener("DOMContentLoaded", () => {
      const params = new URLSearchParams(window.location.search);
      const query  = params.get("query")?.toLowerCase() || "";
      const resultsContainer = document.querySelector(".results ul");
      const titleElement     = document.querySelector(".results h2");

      titleElement.textContent = query
        ? `Résultats pour : "${query}"`
        : "Aucune recherche effectuée.";

      if (!query) return;

      fetch(`/Soradrive/src/controllers/trajet_controller.php?action=recherche_par_destination&query=${encodeURIComponent(query)}`)
        .then(response => {
          if (!response.ok) throw new Error("Erreur réseau");
          return response.json();
        })
        .then(data => {
          resultsContainer.innerHTML = "";
          if (!Array.isArray(data.trajets) || data.trajets.length === 0) {
            resultsContainer.innerHTML = "<li>Aucun trajet trouvé.</li>";
            return;
          }
          data.trajets.forEach(trip => {
            const li = document.createElement("li");
            li.dataset.url = "reserve.html";
            li.innerHTML = `
              <strong>${trip.ville_depart} → ${trip.ville_arrivee}</strong><br>
              ${trip.date} — ${trip.heure_depart}
            `;
            resultsContainer.appendChild(li);
            li.addEventListener('click', () => {
              document.getElementById('modalFrame').src = li.dataset.url;
              document.getElementById('modal').classList.add('open');
            });
          });
        })
        .catch(err => {
          resultsContainer.innerHTML = `<li>Erreur : ${err.message}</li>`;
        });
    });
  </script>
</body>
</html>
